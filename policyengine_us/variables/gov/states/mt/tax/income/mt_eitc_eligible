from policyengine_us.model_api import *


class mt_eitc_eligible(Variable):
    value_type = bool
    entity = TaxUnit
    label = "CalEITC eligible"
    unit = USD
    definition_period = YEAR
    defined_for = StateCode.MT

    def formula(tax_unit, period, parameters):
        person = tax_unit.members
        p = parameters(period).gov.states.mt.tax.income.credits.eitc

        #0. Earned Income less than certain amount
        #1. Earned Income more than 1 dollar
        income = tax_unit("mt_taxable_income", period)
        child_count = tax_unit("eitc_child_count", period)
        max_earning = select(
            [
                filing_status == status.SINGLE, 
                filing_status == status.HEAD_OF_HOUSEHOLD,
                filing_status == status.WIDOW,
                filing_status == status.JOINT,
                filing_status == status.SEPARATE,
             ],
            [
                p.credits.single-household-widow(child_count),
                p.credits.single-household-widow(child_count),
                p.credits.single-household-widow(child_count),
                p.credits.joint(child_count),
                0,
            ],
        )

        meets_earned_income_requirements = (
            income >= p.eligibility.min_earning & income <= max_earning
            )

        #2. Filing Status

        filing_status = tax_unit("filing_status", period)
        status = filing_status.possible_values
        meets_filing_status_requirements=(
            filing_status!=status.SEPARATE
        )

        #3. Investment Income
        eitc_investment_income = tax_unit(
            "eitc_relevant_investment_income", period
        )

        meets_investment_income_requirements = (
            eitc_investment_income <= p.eligibility.max_investment_income
        )


        #4. Social Security Number
        #You, your spouse and all your children must have Social Security numbers that are valid for employment.
        #Children's SSN can be add in mt_is_qualifying_child_for_eitc
        
        return meets_investment_income_requirements & meets_earned_income_requirements & meets_filing_status_requirements
